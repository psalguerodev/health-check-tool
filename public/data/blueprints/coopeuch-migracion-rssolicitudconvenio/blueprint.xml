<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:camelcxf="http://camel.apache.org/schema/blueprint/cxf"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:http="http://cxf.apache.org/transports/http/configuration"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd                                 http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
    <cm:property-placeholder id="propertyGlobal" persistent-id="global" placeholder-prefix="{[" placeholder-suffix="]}" update-strategy="reload"/>
    <cm:property-placeholder id="propertyGlobal2" persistent-id="globalDb2" placeholder-prefix="{" placeholder-suffix="}" update-strategy="reload"/>

    <cm:property-placeholder id="propertyConvenios" persistent-id="wssolicitudconvenio" placeholder-prefix="{{" placeholder-suffix="}}" update-strategy="reload"/>

    <bean class="org.apache.activemq.camel.component.ActiveMQComponent" id="beanAMQ">
        <property name="brokerURL" value="{[amq.broker.url]}"/>
        <property name="userName" value="{[amq.username]}"/>
        <property name="password" value="{[amq.password]}"/>
        <property name="usePooledConnection" value="true"/>
    </bean>

    <bean class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close" id="dataSourceSqlDb2">
        <property name="driverClassName" value="com.ibm.as400.access.AS400JDBCDriver"/>
        <property name="url" value="{jdbc.db2.url.servicio}"/>
        <property name="username" value="{jdbc.db2.username.creditos}"/>
        <property name="password" value="{jdbc.db2.password.creditos}"/>
        <property name="timeBetweenEvictionRunsMillis" value="{{wsSolicitudConvenios.jdbc.db2.timeBetweenEvictionRunsMillis}}"/>
        <property name="numTestsPerEvictionRun" value="{{wsSolicitudConvenios.jdbc.db2.numTestsPerEvictionRun}}"/>
        <property name="minEvictableIdleTimeMillis" value="{{wsSolicitudConvenios.jdbc.db2.minEvictableIdleTimeMillis}}"/>
        <property name="maxActive" value="{{wsSolicitudConvenios.jdbc.db2.maxActive}}"/>
    </bean>

    <bean class="cl.coopeuch.integracion.solicitudconvenio.util.RouteFacade" id="beanRouteFacade"/>
    <camelcxf:cxfEndpoint address="/WSSolicitudConvenio" id="endpointWSSolicitudConvenio" serviceClass="cl.coopeuch.integracion.solicitudconvenio.wsdl.WSSolicitudConvenioSOAPPortType" wsdlURL="etc/wsdl/WSSolicitudConvenio.wsdl">
        <camelcxf:properties>
            <entry key="schema-validation-enabled" value="true"/>
        </camelcxf:properties>
    </camelcxf:cxfEndpoint>
    <camelcxf:rsServer address="/RSSolicitudConvenio"
                       id="endpointRSSolicitudConvenio"
                       serviceClass="cl.coopeuch.integracion.solicitudconvenio.wsdl.WSSolicitudConvenioSOAPPortType">
        <camelcxf:providers>
            <bean id="jsonProvider" class="org.apache.cxf.jaxrs.provider.json.JSONProvider">
                <property name="serializeAsArray" value="true"/>
                <property name="arrayKeys">
                    <list>
                        <value>detalleError</value>
                        <value>entidades</value>
                        <value>aporteEmpleador</value>
                        <value>descuentos</value>
                        <value>rebajas</value>
                    </list>
                </property>
                <property name="ignoreEmptyArrayValues" value="true"/>
            </bean>
        </camelcxf:providers>
    </camelcxf:rsServer>
    
    <camelContext id="servicio-solicitud-convenio" xmlns="http://camel.apache.org/schema/blueprint">
        <threadPoolProfile defaultProfile="true" id="changedProfile"
                           maxQueueSize="100" poolSize="1"/>
        <dataFormats>
            <json id="serializer" library="Jackson" prettyPrint="true"/>
        </dataFormats>
        <redeliveryPolicyProfile id="redeliveryPolicy"
                                 maximumRedeliveries="2"
                                 redeliveryDelay="1000" allowRedeliveryWhileStopping="false"
                                 retryAttemptedLogLevel="INFO" />   
        <onException id="CustomExceptionHandling" redeliveryPolicyRef="redeliveryPolicy" useOriginalMessage="true">
            <exception>java.lang.Exception</exception>
            <handled>
                <constant>true</constant>
            </handled>
            <log loggingLevel="ERROR" message="ERROR: ${camelId} || ${routeId} || ${id} || ${date:now:yyyy-MM-dd'T'HH:mm:ss:SSS} || ${exception.message}"/>
            <log loggingLevel="DEBUG" message="ERROR: ${camelId} || ${routeId} || ${id} || ${date:now:yyyy-MM-dd'T'HH:mm:ss:SSS} || ${exception.stacktrace}"/>

            <bean id="soapFault" method="soapFault" ref="beanRouteFacade"/>
            <log message="(((((${body})))))"/>
            <stop/>
        </onException>
        <route id="inicio-soap">
            <from id="soapInicio" uri="cxf:bean:endpointWSSolicitudConvenio"/>
            <to id="soapToInicioWs" uri="direct:cxf-inicio"/>
        </route>
        <route id="inicio-rest">
            <from id="restInicio" uri="cxfrs:bean:endpointRSSolicitudConvenio"/>
            <to id="restToInicioWs" uri="direct:cxf-inicio"/>
        </route>
        <route id="cxf-inicio">
            <from id="inicioFromServicio" uri="direct:cxf-inicio"/>
            <doTry id="inicioTry">
                <setProperty id="inicioSetRequest" propertyName="requestEntrada">
                    <simple>${body}</simple>
                </setProperty>
                <setProperty id="inicioSetTipoRequest" propertyName="tipoRequest">
                    <simple>$simple{body.get(0).class.getSimpleName()}</simple>
                </setProperty>
                <choice id="inicioChoiceOperacion">
                    <when id="inicioWhenOperacionConsultarCartola">
                        <simple>${header.operationName} == 'consultarCartola'</simple>
                        <to id="toConsultarCartola" uri="direct:consultarCartola"/>
                    </when>
                    <when id="consultarSolicitudRequest">
                        <simple>${header.operationName} == 'consultarSolicitud'</simple>
                        <to id="toConsultarSolicitud" uri="direct:consultarSolicitud"/>
                    </when>
                    <when id="modificarRequest">
                        <simple>${header.operationName} == 'modificar'</simple>
                        <to id="tomodificar" uri="direct:modificar"/>
                    </when>
                    <when id="consultarEntidadRequest">
                        <simple>${header.operationName} == 'consultarEntidad'</simple>
                        <to id="toConsultarEntidad" uri="direct:consultarEntidad"/>
                    </when>
                    <otherwise id="inicioOtherwise">
                        <throwException exceptionType="java.lang.Exception" id="throwExceptionOperacionInvalida" message="La operacion solicitada es invalida"/>
                    </otherwise>
                </choice>
                <doCatch id="inicioDoCatch">
                    <exception>java.lang.Exception</exception>
                    <to id="toInicioExcepcion" uri="direct:excepcion"/>
                </doCatch>
            </doTry>
        </route>


        <route id="consultarSolicitud">
            <from id="consultarSolicitudfrom" uri="direct:consultarSolicitud"/>
            <doTry id="crearTryf">
                <setBody id="consultarSolicitudsetBody">
                    <simple>$simple{body.get(0)}</simple>
                </setBody>

                <marshal id="consultarSolicitudMarshal">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </marshal>

                <setHeader headerName="canalLlamada">
                    <xpath resultType="String">//*[name() = 'canalLlamada']</xpath>
                </setHeader>
                <setHeader headerName="userId">
                    <xpath resultType="String">//*[name() = 'userId']</xpath>
                </setHeader>

                <setHeader headerName="rutEmpleador">
                    <xpath resultType="String">//*[name() = 'rutEmpleador']</xpath>
                </setHeader>
                <setHeader headerName="numero">
                    <xpath resultType="String">//*[name() = 'numero']</xpath>
                </setHeader>
                <setHeader headerName="estado">
                    <xpath resultType="String">//*[name() = 'estado']</xpath>
                </setHeader>
                <setHeader headerName="fecha">
                    <xpath resultType="String">//*[name() = 'fecha']</xpath>
                </setHeader>
                <bean method="validarIngreso" ref="beanRouteFacade"></bean>
                <log message="${headers.validacion}"/>
                <choice>
                    <when>
                        <simple>${headers.validacion}</simple>
                        <setProperty propertyName="codigoError">
                            <simple resultType="Integer">420</simple>
                        </setProperty>
                        <setProperty propertyName="exception.message">
                            <simple>${headers.validacion}</simple>
                        </setProperty>
                        <to uri="direct:excepcion" />
                        <stop />
                    </when>
                </choice>
                <convertBodyTo type="java.lang.String" />
                <bean method="crearJMSCorrelationId24" ref="beanRouteFacade" />
                <convertBodyTo id="consultarSolicitudConvertBodyToString" type="java.lang.String"/>
                <to id="consultarSolicitudToXSLTrama1" uri="xslt://etc/xsl/request/IOC73502I_consultarSolicitud.xsl"/>
                <log id="consultarSolicitudTrama1" message="Trama generada = (${body})"/>
                <to id="consultarSolicitudToAmq1" uri="beanAMQ:{{amq.queue.req}}?preserveMessageQos=true&amp;errorHandlerLoggingLevel=TRACE&amp;jmsMessageType=Text&amp;replyTo={{amq.queue.res}}&amp;replyToType=Shared&amp;replyToOverride={{amq.queue.res}}&amp;synchronous=true&amp;exchangePattern=InOut&amp;requestTimeout=90000"/>
                <transform>
                    <simple>${body.replaceAll("[\n\r]", "\t")}</simple>
                </transform> 
                <transform id="consultarSolicitudTransformBody1">
                    <simple>&lt;trama&gt;&lt;![CDATA[${body}]]&gt;&lt;/trama&gt;</simple>
                </transform>
                <log id="consultarSolicitudTramaResponse" message="Trama recibida = (${body})"/>
                <to id="consultarSolicitudToXSLSOAP" uri="xslt://etc/xsl/response/IOC735002O_consultarSolicitud.xsl?saxon=true"/>
                <log id="consultarSolicitudTramaResponse" message="Trama recibida = ${body}"/>
                <unmarshal id="consultarSolicitudUnmarshal">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </unmarshal>
                <stop/>
                <doCatch>
                    <exception>org.apache.camel.ExchangeTimedOutException</exception>
                    <setProperty propertyName="codigoError">
                        <simple resultType="Integer">502</simple>
                    </setProperty>

                    <to uri="direct:excepcion" />
                </doCatch>
                <doCatch>
                    <exception>java.lang.Exception</exception>
                    <setProperty id="crearCodigoError" propertyName="codigoError">
                        <simple resultType="Integer">500</simple>
                    </setProperty>
                    <to uri="direct:excepcion" />
                </doCatch>
            </doTry>
        </route>



        <route id="consultarCartola">
            <from id="consultarCartolaFrom" uri="direct:consultarCartola"/>
            <doTry id="crearTry">
                <setBody id="consultarCartolaSetBody">
                    <simple>$simple{body.get(0)}</simple>
                </setBody>
                <marshal id="consultarCartolaMarshal">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </marshal>
                <convertBodyTo id="consultarCartolaConvertBodyToString" type="java.lang.String"/>
                <bean id="consultarCartolaUUID" method="crearJMSCorrelationId24" ref="beanRouteFacade"/>
                <to id="consultarCartolaToXSLTrama" uri="xslt://etc/xsl/request/IOC735001I_consultarCartola.xsl"/>
                <log id="consultarCartolaTrama" message="Trama generada = ${body}"/>
                <to id="consultarCartolaToAmq" uri="beanAMQ:{{amq.queue.req}}?preserveMessageQos=true&amp;errorHandlerLoggingLevel=TRACE&amp;jmsMessageType=Text&amp;replyTo={{amq.queue.res}}&amp;replyToType=Shared&amp;replyToOverride={{amq.queue.res}}&amp;synchronous=true&amp;exchangePattern=InOut"/>
                <transform id="consultarCartolaTransformBody">
                    <simple>&lt;trama&gt;${body}&lt;/trama&gt;</simple>
                </transform>
                <log id="consultarCartolaTramaResponse" message="Trama recibida = ${body}"/>
                <to id="consultarCartolaToXSLSOAP" uri="xslt://etc/xsl/response/IOC735001O_consultarCartola.xsl?saxon=true"/>
                <log id="consultarCartolaTramaResponse" message="Trama recibida = ${body}"/>
                <unmarshal id="consultarCartolaUnmarshal">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </unmarshal>
                <bean id="consultarCartolaBeann" method="eliminarDatosMovimientos" ref="beanRouteFacade"/>
                <doCatch id="consultarCartolaDoCatch">
                    <exception>java.lang.Exception</exception>
                    <to id="toCrearExcepcion" uri="direct:excepcion"/>
                </doCatch>
            </doTry>
        </route>

        <route id="modificar">
            <from id="modificarFrom" uri="direct:modificar"/>
            <doTry id="modificarTry">
                <setBody id="modificarSetBody">
                    <simple>$simple{body.get(0)}</simple>
                </setBody>
                <log id="modificarRequestLog" message="Request XML modificar = ${body}"/>
                <marshal id="modificarMarshal">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </marshal>
                <convertBodyTo id="modificarConvertBodyToString" type="java.lang.String"/>
                <setProperty propertyName="identificacionEmpleador">
                    <xpath resultType="String">//antecedentesEmpresa/identificacionEmpleador/text()</xpath>
                </setProperty>
                <setProperty propertyName="numeroSolicitud">
                    <xpath resultType="String">//informacionSolicitud/numeroSolicitud/text()</xpath>
                </setProperty>
                <setProperty propertyName="request">
                    <xpath>/*</xpath>
                </setProperty>
                <to uri="direct:ConsumoDosIOC"/>
                <stop/>

                <doCatch id="modificarDoCatch">
                    <exception>java.lang.Exception</exception>
                    <to id="toCrearExcepcionModificar" uri="direct:excepcion"/>
                </doCatch>
            </doTry>
        </route>


        <route id="ConsumoDosIOC"
               xmlns:ns2="http://integracion.coopeuch.cl/WSEmpresa/">
            <from uri="direct:ConsumoDosIOC"/>
            <removeHeaders pattern="CamelHttp*"/>
            <removeHeaders pattern="JMS*"/>
            <to id="modificarToXSLSOAP1" uri="xslt://etc/xsl/request/IOC741501I_modificarConvenio.xsl?saxon=true"/>
            <setBody>
                <xpath>/*</xpath>
            </setBody>
            <transform>
                <simple>&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsem="http://integracion.coopeuch.cl/WSEmpresa/"&gt;&lt;soapenv:Body&gt;${body}&lt;/soapenv:Body&gt;&lt;/soapenv:Envelope&gt;</simple>
            </transform>
            <transform>
                <simple>${body.replace("modificarRequest","wsem:modificarRequest")}</simple>
            </transform>
            <removeHeaders pattern="CamelHttp*"/>
            <setHeader headerName="Content-Type">
                <constant>application/xml</constant>
            </setHeader>
            <setHeader headerName="CamelHttpMethod">
                <constant>POST</constant>
            </setHeader>
            <setHeader headerName="SOAPAction">
                <constant>"http://integracion.coopeuch.cl/WSEmpresa/modificar"</constant>
            </setHeader>
            <bean id="modificarUUID23" method="crearJMSCorrelationId24" ref="beanRouteFacade"/>
            <to uri="http4://{{wsConvenios.SolicitudConvenios.WsEmpresa.modificar}}?bridgeEndpoint=true&amp;throwExceptionOnFailure=false"/>
            <convertBodyTo type="java.lang.String" charset="UTF-8"/>
            <setBody>
                <xpath>//ns2:modificarResponse/*</xpath>
            </setBody>
            <transform id="modificarEmpleadorTransformBody1">
                <simple resultType="String">&lt;modificarResponse&gt;${body} &lt;/modificarResponse&gt;</simple>
            </transform>
            <log id="modificarXMLResponse1" message="Trama recibida = ${body}"/>
            <setProperty propertyName="codigo1">
                <xpath resultType="String">//codigo/text()</xpath>
            </setProperty>
            <setProperty propertyName="glosa1">
                <xpath resultType="String">//glosa/text()</xpath>
            </setProperty>
            <!--          <stop/>   -->
            <removeHeaders pattern="CamelHttp*"/>
            <removeHeaders pattern="JMS*"/>
            <choice>
                <when>
                    <xpath resultType="String">//formato/text() = 'IOC741501O'</xpath>
                    <setBody id="modificarEmpleadoBody">
                        <simple>${property.request}</simple>
                    </setBody>

                    <bean id="modificarUUID29" method="crearJMSCorrelationId24" ref="beanRouteFacade"/>
                    <to id="modificarToXSLTrama1" uri="xslt://etc/xsl/request/IOC008801I_modificarConvenio.xsl"/>
                    <log id="modificarTrama1" message="Trama generada = (${body})"/>
                    <to id="modificarToAmq1" uri="beanAMQ:{{amq.queue.req}}?preserveMessageQos=true&amp;errorHandlerLoggingLevel=TRACE&amp;jmsMessageType=Text&amp;replyTo={{amq.queue.res}}&amp;replyToType=Shared&amp;replyToOverride={{amq.queue.res}}&amp;synchronous=true&amp;exchangePattern=InOut"/>
                    <transform id="modificarTransformBody1">
                        <simple>&lt;trama&gt;${body}&lt;/trama&gt;</simple>
                    </transform>
                    <log id="modificarTramaResponse1" message="Trama recibida = (${body})"/>
                    <to id="modificarToXSLSOAP1" uri="xslt://etc/xsl/response/IOC008801O_modificarConvenio.xsl?saxon=true"/>
                    <setBody>
                        <xpath>//modificarResponse/*</xpath>
                    </setBody>
                    <transform id="modificarEmpleadorTransformBody2">
                        <simple resultType="String">&lt;modificarResponse&gt;${body}&lt;codigo1&gt;${property.codigo1}&lt;/codigo1&gt; &lt;glosa1&gt;${property.glosa1}&lt;/glosa1&gt; &lt;/modificarResponse&gt;</simple>
                    </transform>
                    <log message="(((${body})))"/>
                    <convertBodyTo type="java.lang.String" charset="UTF-8"/>
                    <to id="modificarToXSLSOAPOrquestador" uri="xslt://etc/xsl/response/IOC008801O_modificarConvenioOrquestador.xsl?saxon=true"/>
                    <convertBodyTo type="java.lang.String" charset="UTF-8"/>
                    <log id="modificarResponseLog" message="Response XML modificar = ${body}"/>
                    <unmarshal id="modificarEmpleadorUnmarshal1">
                        <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl" encoding="UTF-8"/>
                    </unmarshal>
                    <stop/>
                </when>
                <otherwise>
                    <unmarshal id="modificarUnmarshal">
                        <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                    </unmarshal>
                </otherwise>
            </choice>

        </route>

        <route id="consultarEntidad">
            <from id="consultarEntidadFrom" uri="direct:consultarEntidad"/>
            <doTry id="consultarEntidadTry">
                <setBody id="consultarEntidadSetBody">
                    <simple>$simple{body.get(0)}</simple>
                </setBody>
                <setProperty id="consultarEntidad-userId" propertyName="userId">
                    <simple>$simple{body.userId}</simple>
                </setProperty>
                <setProperty id="consultarEntidad-canalLlamada" propertyName="canalLlamada">
                    <simple>$simple{body.canalLlamada}</simple>
                </setProperty>
                <setProperty id="consultarEntidad-numeroSolicitud" propertyName="numeroSolicitud">
                    <simple>$simple{body.numeroSolicitud}</simple>
                </setProperty>
                <setProperty id="consultarEntidad-numeroCliente" propertyName="numeroCliente">
                    <simple>$simple{body.numeroCliente}</simple>
                </setProperty>
                <setProperty id="consultarEntidad-tipoEntidad" propertyName="tipoEntidad">
                    <simple>$simple{body.tipoEntidad}</simple>
                </setProperty>
                <bean id="consultarEntidadBeanProceso" method="procesoConsultarEntidadRequest" ref="beanRouteFacade"/>
                <to id="spConsultarEntidadSeguro" uri="sql-stored:classpath:etc/sql/PA_SEL_SOLICITUDCONVENIO_CONSULTARENTIDAD_WS.sql?dataSource=dataSourceSqlDb2&amp;outputHeader=consultarEntidadPaResponse"/>
                <bean id="consultarEntidadBeanProceso" method="procesoConsultarEntidadResponse" ref="beanRouteFacade"/>
                <unmarshal id="unmarshalConsultarEntidad">
                    <jaxb contextPath="cl.coopeuch.integracion.solicitudconvenio.wsdl"/>
                </unmarshal>
                <doCatch id="consultarEntidadDoCatch">
                    <exception>java.lang.Exception</exception>
                    <setProperty id="consultarEntidadCodigoError" propertyName="codigoError">
                        <constant>500</constant>
                    </setProperty>
                    <to id="toConsultarEntidadExcepcion" uri="direct:excepcion"/>
                </doCatch>
            </doTry>
        </route>

        <route id="excepcion">
            <from id="excepcionfrom" uri="direct:excepcion"/>
            <doTry id="excepcionTry">
                <bean id="beanExceptionAmq" method="excepcionAmq" ref="beanRouteFacade"/>
                <marshal id="excepcionMarshalJson">
                    <json library="Jackson"/>
                </marshal>
                <convertBodyTo id="excepcionConvertTo" type="java.lang.String"/>
                <to id="excepcionToAmqFault" uri="beanAMQ:{{amq.queue.fault}}?errorHandlerLoggingLevel=TRACE&amp;exchangePattern=InOnly"/>
                <bean id="excepcionBeanExcepcion" method="excepcionCrear" ref="beanRouteFacade"/>
                <doCatch id="excepcionDoCatch">
                    <exception>java.lang.Exception</exception>
                    <setBody id="exceptionFinalSetBodyError">
                        <simple>${exception}, Body -&gt; ${body}</simple>
                    </setBody>
                    <log id="excepcionLog" loggingLevel="ERROR" message="Ha ocurrido un error al escribir en la cola de errores o en la ejecucion del servicio: ${body}"/>
                </doCatch>
            </doTry>
        </route>
    </camelContext>
</blueprint>
