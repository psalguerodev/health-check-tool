<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
    xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="              http://www.osgi.org/xmlns/blueprint/v1.0.0 https://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd              http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd              http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
    <!-- Property Placeholder -->
    <cm:property-placeholder persistent-id="serviceProperties" update-strategy="reload"/>
    <!-- Configure CXF endpoint -->
    <cxf:cxfEndpoint address="/ServicioInfoDemografica"
        id="infoDemograficaEndpoint"
        serviceClass="cl.coopeuch.core.infodemografica.infodemografica.InfoDemograficaPortType" wsdlURL="wsdl/ServicioInfoDemografica.wsdl"/>
    <!-- Configure Active MQ connection factory -->
    <bean class="org.apache.activemq.camel.component.ActiveMQComponent" id="AMQ">
        <property name="brokerURL" value="${amq.broker.url}"/>
        <property name="userName" value="${amq.username}"/>
        <property name="password" value="${amq.password}"/>
        <property name="usePooledConnection" value="true"/>
    </bean>
    <!-- Configure JDBC connection -->
    <bean class="org.apache.commons.dbcp.BasicDataSource"
        destroy-method="close" id="dataSource">
        <property name="driverClassName" value="net.sourceforge.jtds.jdbc.Driver"/>
        <property name="url" value="${jdbc.sybase.url.infodemografica}/Coopeuch;charset=iso_1"/>
        <property name="username" value="${jdbc.sybase.username.infodemografica}"/>
        <property name="password" value="${jdbc.sybase.password.infodemografica}"/>
        <property name="timeBetweenEvictionRunsMillis" value="${jdbc.sybase.timeBetweenEvictionRunsMillis.infodemografica}"/>
        <property name="numTestsPerEvictionRun" value="${jdbc.sybase.numTestsPerEvictionRun.infodemografica}"/>
        <property name="minEvictableIdleTimeMillis" value="${jdbc.sybase.minEvictableIdleTimeMillis.infodemografica}"/>
        <property name="maxActive" value="${jdbc.sybase.maxActive.infodemografica}"/>
    </bean>
    <!-- Local Beans -->
    <bean class="org.apache.camel.component.sql.SqlComponent" id="sql">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <bean class="cl.coopeuch.util.db.StoredProcedureBean" id="pa_selcomuna_core">
        <argument ref="dataSource"/>
        <argument value="java.sql.Types"/>
        <argument value="pa_selcomuna_core"/>
        <argument value="false"/>
        <argument>
            <list>
                <map>
                    <entry key="name" value="idRegion"/>
                    <entry key="mode" value="in"/>
                    <entry key="type" value="integer"/>
                </map>
                <map>
                    <entry key="name" value="resultSet"/>
                    <entry key="mode" value="out"/>
                    <entry key="type" value="ResultSet"/>
                </map>
            </list>
        </argument>
    </bean>
    <bean class="cl.coopeuch.util.db.StoredProcedureBean" id="pa_selregion_core">
        <argument ref="dataSource"/>
        <argument value="java.sql.Types"/>
        <argument value="pa_selregion_core"/>
        <argument value="false"/>
        <argument>
            <list>
                <map>
                    <entry key="name" value="resultSet"/>
                    <entry key="mode" value="out"/>
                    <entry key="type" value="ResultSet"/>
                </map>
            </list>
        </argument>
    </bean>
    <bean class="cl.coopeuch.util.db.StoredProcedureBean" id="pa_selregioncomuna_core">
        <argument ref="dataSource"/>
        <argument value="java.sql.Types"/>
        <argument value="pa_selregioncomuna_core"/>
        <argument value="false"/>
        <argument>
            <list>
                <map>
                    <entry key="name" value="idComuna"/>
                    <entry key="mode" value="in"/>
                    <entry key="type" value="integer"/>
                </map>
                <map>
                    <entry key="name" value="resultSet"/>
                    <entry key="mode" value="out"/>
                    <entry key="type" value="ResultSet"/>
                </map>
            </list>
        </argument>
    </bean>
    <camelContext id="servicio-informacion-demografica-context" xmlns="http://camel.apache.org/schema/blueprint">
        <dataFormats>
            <jacksonxml id="jack" prettyPrint="true"/>
        </dataFormats>
        <route id="cx-RuteoOperaciones">
            <from id="infoDemograficaEndpointListener" uri="cxf:bean:infoDemograficaEndpoint?DataFormat=MESSAGE"/>
            <doTry id="ruteoOperacionesTry">
                <convertBodyTo id="ruteoOperacionesBodyTo" type="java.lang.String"/>
                <bean beanType="cl.coopeuch.util.other.BodyBackup"
                    id="backupBody" method="backupBody"/>
                <choice id="ruteoOperaciones">
                    <when id="rutaconsultaComunasPorRegion">
                        <simple>${body} contains 'consultaComunasPorRegion'</simple>
                        <to id="consultaComunasPorRegionValidator" uri="validator:xsd/soapComunasPorRegion.xsd"/>
                        <to id="consultaComunasPorRegionTo" uri="direct:consultaComunasPorRegion"/>
                    </when>
                    <when id="rutaconsultaRegiones">
                        <simple>${body} contains 'consultaRegiones'</simple>
                        <to id="consultaRegionesValidator" uri="validator:xsd/soapRegiones.xsd"/>
                        <to id="consultaRegionesTo" uri="direct:consultaRegiones"/>
                    </when>
                    <when id="rutaconsultaRegionPorComuna">
                        <simple>${body} contains 'consultaRegionPorComuna'</simple>
                        <to id="consultaRegionPorComunaValidator" uri="validator:xsd/soapRegionPorComuna.xsd"/>
                        <to id="consultaRegionPorComunaTo" uri="direct:consultaRegionPorComuna"/>
                    </when>
                </choice>
                <doCatch id="ruteoOperacionesCatch">
                    <exception>java.lang.Exception</exception>
                    <exception>java.io.IOException</exception>
                    <bean beanType="cl.coopeuch.util.other.BodyBackup"
                        id="ruteoOperacionesRestoreBody" method="restoreBody"/>
                    <setBody id="ruteoOperacionesSetBodyError">
                        <simple>ERROR:${exception}:${body}</simple>
                    </setBody>
                    <to id="ruteoOperacionesFault" uri="AMQ:{{amq.queue.amq.fault}}?errorHandlerLoggingLevel=TRACE&amp;exchangePattern=InOnly"/>
                    <bean beanType="cl.coopeuch.util.error.SetBodyError"
                        id="ruteoOperacionesBodyError" method="setBodyError"/>
                </doCatch>
                <doFinally id="ruteoOperacionesFinally"/>
            </doTry>
        </route>
        <route id="consultaComunasPorRegion">
            <from id="consultaComunasPorRegionFrom" uri="direct:consultaComunasPorRegion"/>
            <doTry id="consultaComunasPorRegionTry">
                <setHeader headerName="idRegion" id="consultaComunasPorRegionHeaderIdRegion">
                    <xpath resultType="java.lang.String">//idRegion/text()</xpath>
                </setHeader>
                <to id="pa_selcomuna_core" uri="bean:pa_selcomuna_core"/>
                <marshal id="consultaComunasPorRegionResultset2xml" ref="jack"/>
                <to id="consultaComunasPorRegion2xml" uri="xslt://transformations/out/resultset2xml_consultaComunasPorRegion.xsl?saxon=true"/>
                <doCatch id="consultaComunasPorRegionCatch">
                    <exception>java.lang.Exception</exception>
                    <exception>java.io.IOException</exception>
                    <bean beanType="cl.coopeuch.util.other.BodyBackup"
                        id="consultaComunasPorRegionRestoreBody" method="restoreBody"/>
                    <setBody id="consultaComunasPorRegionSetBodyError">
                        <simple>ERROR:${exception}:${body}</simple>
                    </setBody>
                    <to id="consultaComunasPorRegionFault" uri="AMQ:{{amq.queue.amq.fault}}?errorHandlerLoggingLevel=TRACE&amp;exchangePattern=InOnly"/>
                    <bean beanType="cl.coopeuch.util.error.SetBodyError"
                        id="consultaComunasPorRegionSetBodyError" method="setBodyError"/>
                </doCatch>
                <doFinally id="consultaComunasPorRegionFinally"/>
            </doTry>
        </route>
        <route id="consultaRegiones">
            <from id="consultaRegionesFrom" uri="direct:consultaRegiones"/>
            <doTry id="consultaRegionesTry">
                <setHeader headerName="userId" id="consultaComunasPorRegionUserId">
                    <xpath resultType="java.lang.String">//userId/text()</xpath>
                </setHeader>
                <to id="pa_selregion_core" uri="bean:pa_selregion_core"/>
                <marshal id="consultaRegionesResultset2xml" ref="jack"/>
                <to id="consultaRegiones2xml" uri="xslt://transformations/out/resultset2xml_consultaRegiones.xsl?saxon=true"/>
                <doCatch id="consultaRegionesCatch">
                    <exception>java.lang.Exception</exception>
                    <exception>java.io.IOException</exception>
                    <bean beanType="cl.coopeuch.util.other.BodyBackup"
                        id="consultaRegionesRestoreBody" method="restoreBody"/>
                    <setBody id="consultaRegionesSetBodyError">
                        <simple>ERROR:${exception}:${body}</simple>
                    </setBody>
                    <to id="consultaRegionesFault" uri="AMQ:{{amq.queue.amq.fault}}?errorHandlerLoggingLevel=TRACE&amp;exchangePattern=InOnly"/>
                    <bean beanType="cl.coopeuch.util.error.SetBodyError"
                        id="consultaRegionesSetBodyError" method="setBodyError"/>
                </doCatch>
                <doFinally id="consultaRegionesFinally"/>
            </doTry>
        </route>
        <route id="consultaRegionPorComuna">
            <from id="consultaRegionPorComunaFrom" uri="direct:consultaRegionPorComuna"/>
            <doTry id="consultaRegionPorComunaTry">
                <setHeader headerName="idComuna" id="consultaComunasPorRegionHeaderIdComuna">
                    <xpath resultType="java.lang.String">//idComuna/text()</xpath>
                </setHeader>
                <to id="pa_selregioncomuna_core" uri="bean:pa_selregioncomuna_core"/>
                <marshal id="consultaRegionPorComunaResultset2xml" ref="jack"/>
                <to id="consultaRegionPorComuna2xml" uri="xslt://transformations/out/resultset2xml_consultaRegionPorComuna.xsl?saxon=true"/>
                <doCatch id="consultaRegionPorComunaCatch">
                    <exception>java.lang.Exception</exception>
                    <exception>java.io.IOException</exception>
                    <bean beanType="cl.coopeuch.util.other.BodyBackup"
                        id="consultaRegionPorComunaRestoreBody" method="restoreBody"/>
                    <setBody id="consultaRegionPorComunaSetBodyError">
                        <simple>ERROR:${exception}:${body}</simple>
                    </setBody>
                    <to id="consultaRegionPorComunaFault" uri="AMQ:{{amq.queue.amq.fault}}?errorHandlerLoggingLevel=TRACE&amp;exchangePattern=InOnly"/>
                    <bean beanType="cl.coopeuch.util.error.SetBodyError"
                        id="consultaRegionPorComunaSetBodyError" method="setBodyError"/>
                </doCatch>
                <doFinally id="consultaRegionPorComunaFinally"/>
            </doTry>
        </route>
    </camelContext>
</blueprint>
